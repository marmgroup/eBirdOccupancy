---
editor_options: 
  chunk_output_type: console
---

In this section, we will visualize the cumulative AIC weights and the magnitude and direction of species-specific probability of occupancy

## Prepare libraries

```{r load_libs_results01, eval=FALSE}
# to load data
library(readxl)

# to handle data
library(dplyr)
library(readr)
library(forcats)
library(tidyr)
library(purrr)
library(stringr)

# to wrangle models
source("code/fun_model_estimate_collection.r")
source("code/fun_make_resp_data.r")

# nice tables
library(knitr)
library(kableExtra)

# plotting
library(ggplot2)
library(patchwork)
source("code/fun_plot_interaction.r")
```

## Read the final list of species

```{r eval=FALSE}
# list of species
species <- read_csv("data/species_list.csv")
list_of_species <- as.character(species$scientific_name)

# trait data
species_trait <- read_csv("data/species-trait-dat.csv")
```

## Show AIC weights

### Read in weight data

```{r}
# which files to read
file_names <- c("data/results/lc-clim-imp.xlsx")

# read in sheets by species
model_imp <- map(file_names, function(f) {
  md_list <- map(list_of_species, function(sn) {
    
    # some sheets are not found
    
    tryCatch({
      
      readxl::read_excel(f, sheet = sn) %>% 
        `colnames<-`(c("predictor", "AIC_weight")) %>% 
        filter(str_detect(predictor, "psi")) %>% 
        mutate(predictor = stringr::str_extract(predictor, 
                                pattern = stringr::regex("\\((.*?)\\)")),
               predictor = stringr::str_replace_all(predictor, "[//(//)]", ""),
               predictor = stringr::str_remove(predictor, "\\.y"))
      
      },
      error = function(e) {
        message(as.character(e))
      }
    )
  })
  names(md_list) <- list_of_species
  
  return(md_list)
})
```

### Show cumulative weights as plot

```{r}
# assign scale - minimum spatial scale at which the analysis was carried out to account for observer effort
names(model_imp) <- c("2.5km")
model_imp <- imap(model_imp, function(.x, .y) {
  .x <- bind_rows(.x)
  .x$scale <- .y
  return(.x)
})

# bind rows
model_imp <- map(model_imp, bind_rows) %>% 
  bind_rows()

# convert to numeric
model_imp$AIC_weight <- as.numeric(model_imp$AIC_weight)
model_imp$scale <- as.factor(model_imp$scale)
levels(model_imp$scale) <- c("2.5km")

# Let's get a summary of cumulative variable importance
model_imp <-group_by(model_imp, predictor) %>%
  summarise(mean_AIC = mean(AIC_weight), sd_AIC=sd(AIC_weight),
            min_AIC = min(AIC_weight),
            max_AIC = max(AIC_weight),
            med_AIC = median(AIC_weight))

# sum by scale and predictor
model_imp <- group_by(model_imp, predictor, scale) %>% 
  summarise(AIC_weight_cumulative = sum(AIC_weight))

# write to file
write_csv(model_imp,
          path = "data/results/cumulative_AIC_weights.csv")
```

```{r}
predictor_name <- c("Temp" = "Mean annual temperature",
                    "Ppt" = "Mean annual precipitation",
                    "LC 1" = "% agriculture",
                    "LC 2" = "% forests",
                    "LC 4" = "% plantations",
                    "LC 5" = "% settlements",
                    "LC 6" = "% tea",
                    "LC 7" = "% water bodies")
```

### Make plot

```{r}
ggplot(model_imp)+
  geom_point(aes(predictor, AIC_weight_cumulative),
             size = 3,
           position = position_dodge(width = 0.5),
           shape = 21)+
  geom_col(aes(predictor, AIC_weight_cumulative,
               fill = scale),
           colour = NA,
           width = 0.05,
           alpha = 0.5,
           position = position_dodge(width = 0.5))+
  scale_y_continuous(breaks = seq(45, 75, 10))+
  scale_x_discrete(labels = names(predictor_name))+
  # scale_color_brewer(palette = "RdBu", values = c(0.5, 1))+
  scale_fill_brewer(palette = "RdBu")+
  coord_cartesian(ylim = c(45, 75))+
  theme_test(base_size = 10)+
  theme(legend.position = "none")+
  labs(x = "Predictor",
       y = "Cumulative AIC weight")

ggsave("figs/fig_aic_weight.png", dpi = 300,
       width = 4, height = 4)
```

![Cumulative AIC weights for each predictor, where _Temp_ is the mean annual temperature, _Ppt_ is the mean annual precipitation, and LC 1 -- LC 7 are the proportions of agriculture, forests, plantations, settlements, tea, and water bodies, respectively."](figs/fig_aic_weight.png)

## Read model estimates

```{r read_model_estimates, eval=FALSE}
file_read <- c("data/results/lc-clim-modelEst.xlsx")

# read data as list column
model_est <- map(file_read, function(fr) {
  md_list <- map(list_of_species, function(sn) {
    readxl::read_excel(fr, sheet = sn)
  })
  names(md_list) <- list_of_species
  return(md_list)
})

# prepare model data
scales = c("2.5km")
model_data <- tibble(scale = scales, 
                              scientific_name = list_of_species) %>%
  arrange(desc(scale))

# rename model data components and separate predictors
names <- c("predictor", "coefficient", "se", "ci_lower", 
           "ci_higher", "z_value", "p_value")

# get data for plotting:
model_est <- map(model_est, function(l) {
  map(l, function(df) {
    colnames(df) <- names
    df <- separate_interaction_terms(df)
    df <- make_response_data(df) 
    return(df)
  })
})

# add names and scales
model_est <- map(model_est, function(l) {
  imap(l, function(.x, .y) {
    mutate(.x, scientific_name = .y)
  })
})

# add names to model estimates
names(model_est) <- scales
model_est <- imap(model_est, function(.x, .y) {
  bind_rows(.x) %>% 
    mutate(scale = .y)
})

# remove modulators
model_est <- bind_rows(model_est) %>% 
  select(-matches("modulator"))

# join data to species name
model_data <- model_data %>% 
  left_join(model_est)

# Keep only those predictors whose p-vlaues are significant:
model_data <- model_data %>%
  filter(p_value<0.05)

```

### Export data to file

Export predictor effects.

```{r}
# get predictor effect data
data_predictor_effect <- distinct(model_data, 
                                  scientific_name, 
                                  se,
                                  predictor, coefficient)

# write to file
write_csv(data_predictor_effect,
          path = "data/results/data_predictor_effect.csv")
```

Export model data.

```{r}
model_data_to_file <- model_data %>% 
  select(predictor, data,
         scientific_name, scale) %>% 
  unnest(cols = "data")

# remove .y
model_data_to_file <- model_data_to_file %>% 
  mutate(predictor = str_remove(predictor, "\\.y"))

write_csv(model_data_to_file,
          "data/results/data_occupancy_predictors.csv")
```

Summarizing results of species-specific probability of occupancy as a function of the direction of coefficients
```{r}
# read from file
model_data <- read_csv("data/results/data_predictor_effect.csv")
```

Plot the number of species affected and the direction of the effect, for each predictor.

```{r}
# remove .y from predictors
model_data <- model_data %>%
  mutate_at(.vars = c("predictor"), .funs = function(x){
    stringr::str_remove(x, ".y")
  })
```

### Get predictor effects
```{r}
# is the coeff positive? how many positive per scale per predictor per axis of split?
data_predictor <- mutate(model_data, 
                                direction = coefficient > 0) %>% 
  count(predictor, 
        direction) %>% 
  mutate(mag = n * (if_else(direction, 1, -1)))

# wrangle data to get nice bars
data_predictor_long <- data_predictor%>% 
  select(-n) %>% 
  drop_na(direction) %>% 
  mutate(direction = ifelse(direction, "positive", "negative")) %>% 
  pivot_wider(values_from = "mag", names_from = "direction") %>% 
  mutate_at(vars(positive, negative),
            ~if_else(is.na(.), 0, .))

data_predictor_long <- data_predictor_long %>% 
  pivot_longer(cols = c("negative", "positive"),
               names_to = "effect",
               values_to = "magnitude")

# write
write_csv(data_predictor_long,
          path = "data/results/data_predictor_direction_nSpecies.csv")
```

Plot the above data: Species-specific prob of occupancy ~ direction
```{r}
fig_predictor <- ggplot(data_predictor_long)+
            geom_hline(yintercept = 0,
                       lwd = 0.2,
                       col = "grey")+
            geom_col(aes(x = factor(predictor),
                         y = magnitude),
                     colour=NA,
                     # position = position_dodge(width = 1),
                     width = 0.05)+
            geom_point(aes(x = factor(predictor),
                         y = magnitude),
                     # position = position_dodge(width = 1),
                     size = 3,
                     shape = 21)+
            scale_x_discrete(labels = names(predictor_name))+
            scale_y_continuous()+
            scale_fill_brewer(palette =  "RdBu")+
            theme_test()+
            theme(legend.position = "none")+
            labs(x = "Predictor", y = "# Species",
                 title = 'Magnitude and direction of Species-specific probability of occupancy')

ggsave("figs/fig_prob_occupancy_dir.png", dpi = 300,
       width = 12, height = 7)
    
```


