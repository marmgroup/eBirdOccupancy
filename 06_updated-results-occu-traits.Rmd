---
editor_options: 
  chunk_output_type: console
---

# Results: Occupancy predictors

## Prepare libraries

```{r load_libs_results01, eval=FALSE}
# to load data
library(readxl)

# to handle data
library(dplyr)
library(readr)
library(forcats)
library(tidyr)
library(purrr)
library(stringr)

# to wrangle models
source("code/fun_model_estimate_collection.r")
source("code/fun_make_resp_data.r")

# nice tables
library(knitr)
library(kableExtra)

# plotting
library(ggplot2)
library(patchwork)
source("code/fun_plot_interaction.r")
```

## Read species trait data and the final list of species

```{r eval=FALSE}
# list of species
species <- read_csv("data/species_list.csv")
list_of_species <- as.character(species$scientific_name)

# trait data
species_trait <- read_csv("data/data_species_trait.csv")
```

## Show AIC weights

### Read in weight data

```{r}
# which files to read
file_names <- c("data/results/occu-2.5km/occuCovs/modelImp/lc-clim-imp.xlsx",
                "data/results/occu-10km/occuCovs/modelImp/lc-clim-imp.xlsx")

# read in sheets by species
model_imp <- map(file_names, function(f) {
  md_list <- map(list_of_species, function(sn) {
    
    # some sheets are not found
    
    tryCatch({
      
      readxl::read_excel(f, sheet = sn) %>% 
        `colnames<-`(c("predictor", "AIC_weight")) %>% 
        filter(str_detect(predictor, "psi")) %>% 
        mutate(predictor = stringr::str_extract(predictor, 
                                pattern = stringr::regex("\\((.*?)\\)")),
               predictor = stringr::str_replace_all(predictor, "[//(//)]", ""),
               predictor = stringr::str_remove(predictor, "\\.y"))
      
      },
      error = function(e) {
        message(as.character(e))
      }
    )
  })
  names(md_list) <- list_of_species
  
  return(md_list)
})
```

Sheets for one laughingthrush _Montecincla fairbankii_ and one barbet _Psilopogon viridis_ are not found at both scales.

### Show cumulative weights as plot

```{r}
# assign scale
names(model_imp) <- c("2.5km", "10km")
model_imp <- imap(model_imp, function(.x, .y) {
  .x <- bind_rows(.x)
  .x$scale <- .y
  return(.x)
})

# bind rows
model_imp <- map(model_imp, bind_rows) %>% 
  bind_rows()

# convert to numeric
model_imp$AIC_weight <- as.numeric(model_imp$AIC_weight)
model_imp$scale <- as.factor(model_imp$scale)
levels(model_imp$scale) <- c("2.5km", "10km")

# summ by scale and predictor
model_imp <- group_by(model_imp, predictor, scale) %>% 
  summarise(AIC_weight_cumulative = sum(AIC_weight))
```



```{r}
predictor_name <- c("Temp" = "Mean annual temp.",
                    "Ppt" = "Mean annual ppt.",
                    "LC 1" = "% agriculture",
                    "LC 2" = "% forests",
                    "LC 3" = "% plantations",
                    "LC 4" = "% settlements",
                    "LC 5" = "% tea",
                    "LC 6" = "% water bodies")
```


### Make plot

```{r}
ggplot(model_imp)+
  geom_point(aes(predictor, AIC_weight_cumulative,
               fill = scale),
             size = 3,
           position = position_dodge(width = 0.5),
           shape = 21)+
  geom_col(aes(predictor, AIC_weight_cumulative,
               fill = scale),
           colour = NA,
           width = 0.05,
           alpha = 0.5,
           position = position_dodge(width = 0.5))+
  scale_y_continuous(breaks = seq(45, 75, 10))+
  scale_x_discrete(labels = names(predictor_name))+
  # scale_color_brewer(palette = "RdBu", values = c(0.5, 1))+
  scale_fill_brewer(palette = "BuPu")+
  coord_cartesian(ylim = c(45, 75))+
  theme_test(base_size = 10)+
  theme(legend.position = "none")+
  labs(x = "Predictor",
       y = "Cumulative AIC weight")

ggsave("figs/fig_aic_weight.png", dpi = 300,
       width = 4, height = 4)
```

![Cumulative AIC weights for each predictor, where _Temp_ is the mean annual temperature, _Ppt_ is the mean annual precipitation, and LC 1 -- LC 6 are the proportions of agriculture, forest, plantation, settlement, tea, and water bodies, respectively."](figs/fig_aic_weight.png)

## Read model estimates

```{r read_model_estimates, eval=FALSE}
file_read <- c("data/results/occu-2.5km/occuCovs/modelEst/lc-clim-modelEst.xlsx",
               "data/results/occu-10km/occuCovs/modelEst/lc-clim-modelEst.xlsx")

# read data as list column
model_est <- map(file_read, function(fr) {
  md_list <- map(list_of_species, function(sn) {
    readxl::read_excel(fr, sheet = sn)
  })
  names(md_list) <- list_of_species
  
  return(md_list)
})

# prepare model data
scales = c("2.5km", "10km")
model_data <- tibble(crossing(scale = scales, 
                              scientific_name = list_of_species)) %>% 
  arrange(desc(scale))

# rename model data components and separate predictors
names <- c("predictor", "coefficient", "se", "ci_lower", 
           "ci_higher", "z_value", "p_value")

# get data for plotting:
model_est <- map(model_est, function(l) {
  map(l, function(df) {
    colnames(df) <- names
    df <- separate_interaction_terms(df)
    df <- make_response_data(df) 
    return(df)
  })
})

# add names and scales
model_est <- map(model_est, function(l) {
  imap(l, function(.x, .y) {
    mutate(.x, scientific_name = .y)
  })
})

# add names to model estimates
names(model_est) <- scales
model_est <- imap(model_est, function(.x, .y) {
  bind_rows(.x) %>% 
    mutate(scale = .y)
})

# remove modulators
model_est <- bind_rows(model_est) %>% 
  select(-matches("modulator"))

# join data to species name
model_data <- model_data %>% 
  left_join(model_est)
```

### Export data to file

Export predictor effects.

```{r}
# get predictor effect data
data_predictor_effect <- distinct(model_data, 
                                  scientific_name, scale, 
                                  predictor, coefficient)

# write to file
write_csv(data_predictor_effect,
          path = "data/results/data_predictor_effect.csv")
```

Export model data.

```{r}
model_data_to_file <- model_data %>% 
  select(predictor, data,
         scientific_name, scale) %>% 
  unnest(cols = "data")

# remove .y
model_data_to_file <- model_data_to_file %>% 
  mutate(predictor = str_remove(predictor, "\\.y"))

write_csv(model_data_to_file,
          "data/results/data_occupancy_predictors.csv")
```

## Occupancy coefficients in relation with species elevation

How does species' displacement from the median elevation of the study area relate with the coefficient of each predictor of occupancy?

First get the saved model data.

```{r}
# read from file
model_data <- read_csv("data/results/data_predictor_effect.csv")
```

### Species offset from median elevation

```{r}
# add trait by joining
model_data <- model_data %>% 
  left_join(species_trait, by = "scientific_name")

# add elevation data
elev_summary <- read_excel("data/data_species_elevation.xlsx")
model_data <- left_join(model_data, elev_summary)

model_data <- rename(model_data,
                     median_elev = median)
```

```{r elev_of_area}
# what is the median elevation of the study area?
elev <- raster::stack("data/spatial/landscape_resamp01km.tif")[[1]]

# mask the raster by the hills shapefile
library(sf)
hills <- sf::st_read("data/spatial/hillsShapefile/Nil_Ana_Pal.shp") %>% 
  sf::`st_crs<-`(4326) %>% 
  sf::st_transform(32643)

# get masked elevation
elev <- raster::mask(elev, sf::as_Spatial(hills))

# get median elevation
median(raster::values(elev), na.rm = TRUE)
```

The median elevation is 686.0872 metres, which we will round to 685 metres for convenience.

```{r}
med_elev <- 685
```

Subtract species' median elevation from the study area median elevation.

```{r}
model_data$diff_elev <- model_data$median_elev - med_elev

model_data <- drop_na(model_data)
```

### Species body mass

Already included in the data.

### Species range size

This data is added from the State of India's Birds report.

```{r}
soib <- read_csv("data/2020_state-india-birds-trait-dat - Information.csv")
soib <- select(soib,
               scientific_name = `Scientific Name (India Checklist)`,
               range_size = `Distribution Range Size (units of 10,000 sq. km.)`)

# join with model data
model_data <- left_join(model_data, soib,
                        by = "scientific_name")
```

### Prepare divisions by trait for plotting

```{r}
model_data <- select(model_data,
                     scientific_name, predictor, coefficient,
                     scale, 
                     range_size = range_size.y,
                     diff_elev,
                     body_mass)

model_data_long <- pivot_longer(model_data,
                           cols = c("range_size", "diff_elev", "body_mass"),
                           names_to = "trait",
                           values_to = "trait_value")

# no peacock!
model_data_long <- filter(model_data_long,
                          scientific_name != "Pavo cristatus")
```


### Effect of traits as continuous variables

```{r}
ggplot(model_data_long)+
  geom_hline(yintercept = 0, size = 0.2)+
  geom_vline(xintercept = 0,
             size = 0.1)+
  geom_point(aes(trait_value, coefficient,
                 col = predictor),
             size = 0.5, shape = 4)+
  geom_smooth(aes(trait_value, coefficient,
                  col = predictor),
              method = "glm", 
              se = F, size = 0.5)+
  scale_x_continuous(labels = scales::comma)+
  scale_colour_manual(values = pals::kovesi.rainbow(8))+
  facet_grid(scale ~ trait, scales = "free_x",
             labeller = label_both)+
  ylim(-5, 5)+
  # coord_cartesian(xlim = c(-500, 1000),
                  # ylim = c(-5, 5))+
  theme_test()

# export
ggsave("figs/fig_trait_coeff.png", dpi = 300)
```

---

## Occupancy predictors' aggregated effect

```{r}
# read from file
model_data <- read_csv("data/results/data_predictor_effect.csv")
```

Plot the number of species affected and the direction of the effect, for each predictor.
Split the data along the axes of range size, migratory status, and habitat.

### Add trait data and clean

```{r}
# add trait by joining
model_data <- model_data %>% 
  left_join(species_trait, by = "scientific_name")
```


```{r}
# remove .y from predictors
model_data <- model_data %>%
  mutate_at(.vars = c("predictor"), .funs = function(x){
    stringr::str_remove(x, ".y")
  })
```

What is the direction of the predictor effect for each subset of the data by the distribution, habitat, elevation, and migratory status?

### Get predictor effects

```{r}
# first pivot the data longer
data_predictor_long <- model_data %>% 
  pivot_longer(cols = c("range_size", "migratory_status", 
                        "habitat", "elev"), 
               names_to = "trait",
               values_to = "Class")

# reorder scale
data_predictor_long <- data_predictor_long %>% 
  mutate(scale = fct_relevel(scale, "2.5km", "10km"))

# is the coeff positive? how many positive per scale per predictor per axis of split?
data_predictor_long <- mutate(data_predictor_long, 
                                direction = coefficient > 0) %>% 
  count(scale, predictor, 
        trait, Class, direction) %>% 
  mutate(mag = n * (if_else(direction, 1, -1)))

# wrangle data to get nice bars
data_predictor_long <- data_predictor_long %>% 
  select(-n) %>% 
  drop_na(direction, Class) %>% 
  mutate(direction = ifelse(direction, "positive", "negative")) %>% 
  pivot_wider(values_from = "mag", names_from = "direction") %>% 
  mutate_at(vars(positive, negative),
            ~if_else(is.na(.), 0, .))

data_predictor_long <- data_predictor_long %>% 
  pivot_longer(cols = c("negative", "positive"),
               names_to = "effect",
               values_to = "magnitude")

# write
write_csv(data_predictor_long,
          path = "data/results/data_predictor_long.csv")

# nest the data by trait
data_predictor_long <- data_predictor_long %>% 
  nest(data = -trait)
```

### Manual edits to levels

```{r}
# arrange data predictor long elevation in order of values
data_predictor_long$data[[1]]$Class <- as.factor(data_predictor_long$data[[1]]$Class)
levels(data_predictor_long$data[[1]]$Class) <- c("Low", "Mid", "High")

# fix trait values
data_predictor_long$trait <- c("Elevation range",
                               "Habitat type",
                               "Migratory status",
                               "Range size")
```


### Make figures for predictor effects

```{r}
# visualise the data by mapping over the nested list
data_predictor_long <- mutate(data_predictor_long,
        figs = map2(data, trait, function(df, tr){
          ggplot(df)+
            geom_hline(yintercept = 0,
                       lwd = 0.2,
                       col = "grey")+
            geom_col(aes(x = factor(predictor),
                         y = magnitude,
                         group = interaction(effect, scale)),
                     # position = position_dodge(width = 1),
                     width = 0.05)+
            
            geom_point(aes(x = factor(predictor),
                         y = magnitude,
                         fill = interaction(effect, scale)),
                     # position = position_dodge(width = 1),
                     size = 3,
                     shape = 21)+
            
            scale_x_discrete(labels = names(predictor_name))+
            scale_y_continuous()+
            
            scale_fill_manual(values = 
                                RColorBrewer::brewer.pal(5, "RdBu")[c(1, 4,
                                                                      2, 5)])+
            
            theme_test()+
            theme(legend.position = "none")+
            facet_grid(Class ~ scale, 
                       labeller = label_both)+
            labs(x = "Predictor", y = "# Species",
                 title = glue::glue('Trait: {tr}'))
        }))

fig_predictor_effect <- patchwork::wrap_plots(data_predictor_long$figs,
                                              nrow = 2)

# save plot
ggsave(fig_predictor_effect, filename = "figs/fig_predictor_effect.png",
       dpi = 300,
       width = 12)
```

```{r show_reverse_bar, eval=TRUE}
knitr::include_graphics("figs/fig_predictor_effect.png")
```

### Tabulate predictor effect

```{r eval=TRUE, results="asis"}
# read again and nest
data_predictor_long <- readr::read_csv("data/results/data_predictor_long.csv")

# nest the data by trait
data_predictor_long <- tidyr::nest(data_predictor_long,
                                   data = -trait)

# first pivot the data columns
purrr::pwalk(data_predictor_long, function(trait, data) {
  predictors <- unique(data$predictor)
  headers <- c(1, 1, rep(2, length(predictors)))
  names(headers) <- c(rep(" ", 2), predictors)
  
  data %>% 
    tidyr::drop_na() %>% 
    tidyr::pivot_wider(names_from = c("predictor", "effect"), 
                values_from = "magnitude") %>% 
    
    
    `colnames<-`(c("spatial scale", glue::glue("{trait} class"),
                 rep(c("-ve", "+ve"), length(predictors)))) %>% 
    knitr::kable(caption = glue::glue("Predictor effects for {trait}")) %>% 
    kableExtra::kable_styling("striped", full_width = F,
                              font_size = 8) %>% 
    kableExtra::add_header_above(headers) %>% 
    print()
  cat("\n")
})
```


## Land cover or climate?

Group the predictor data by two broad classes, landcover or climate.

### Get the effect of landcover or climate

```{r}
# remove figs and unnest
data_predictor_long <- data_predictor_long %>% 
  select(!matches("figs")) %>% 
  unnest(data)

# group by predictor
data_lc_v_clim <- data_predictor_long %>% 
  mutate(predictor = if_else(str_detect(predictor, "bio"), 
                             "climate", "landcover")) %>% 
  group_by(trait, scale, predictor, Class, effect) %>%
  summarise_at(.vars = c("magnitude"),
               .funs = list(sum))

# save for later use
write_csv(data_lc_v_clim, path = "data/data_lc_v_clim.csv")
```

```{r}
# nest on trait
data_lc_v_clim <- nest(data_lc_v_clim,
                       cols = -trait)
```


### Plot a figure

```{r}
# make list of figures
data_lc_v_clim$figs <- pmap(data_lc_v_clim[,c("trait", "cols")],
                           function(trait, cols) {
                             ggplot(cols) +
                               
                               geom_hline(yintercept = 0,
                                          lwd = 0.2,
                                          col = "grey")+
                               geom_col(aes(x = factor(predictor),
                                            y = magnitude,
                                            group = interaction(effect, scale)),
                                        # position = position_dodge(width = 1),
                                        width = 0.01)+
                               
                               geom_point(aes(x = factor(predictor),
                                              y = magnitude,
                                              fill = interaction(effect, scale)),
                                          # position = position_dodge(width = 1),
                                          size = 3,
                                          shape = 21)+
                               
                               scico::scale_fill_scico_d(palette = "berlin",
                                                      direction = -1,
                                                      begin = 0.1, end = 0.9)+
                               theme_test(base_family = "TT Arial") +
                               theme(legend.position = "none") +
                               
                               facet_grid(Class ~ scale,
                                          labeller = label_both) +
                               labs(title = glue::glue('trait: {trait}'),
                                    x = NULL,
                                    y = "# species with signed effect")
                           })
fig_lc_v_clim <- patchwork::wrap_plots(data_lc_v_clim$figs,
                                       nrow = 2)

# save plot
ggsave(fig_lc_v_clim, filename = "figs/fig_lc_v_clim.png",
       dpi = 300)
```

```{r}
knitr::include_graphics("figs/fig_lc_v_clim.png")
```

### Tabulate landcover vs climate

```{r eval=TRUE, results="asis"}
# read again and nest
data_lc_v_clim <- read_csv("data/data_lc_v_clim.csv")

# nest again
data_lc_v_clim <- nest(data_lc_v_clim,
                       data = -trait)

# first pivot the data columns
purrr::pwalk(data_lc_v_clim, function(trait, data) {
  predictors <- unique(data$predictor)
  headers <- c(1, 1, rep(2, length(predictors)))
  names(headers) <- c(rep(" ", 2), predictors)
  
  data %>% 
    tidyr::drop_na() %>% 
    tidyr::pivot_wider(names_from = c("predictor", "effect"), 
                values_from = "magnitude") %>% 
    
    
    `colnames<-`(c("spatial scale", glue::glue("{trait} class"),
                 rep(c("-ve", "+ve"), length(predictors)))) %>% 
    knitr::kable(caption = glue::glue("Predictor effects for {trait}")) %>% 
    kableExtra::kable_styling("striped", full_width = F,
                              font_size = 8) %>% 
    kableExtra::add_header_above(headers) %>% 
    print()
  cat("\n")
})
```