---
editor_options: 
  chunk_output_type: console
---

# Results: Occupancy predictors

## Prepare libraries

```{r load_libs_results01, eval=FALSE}
# to load data
library(readxl)

# to handle data
library(dplyr)
library(readr)
library(forcats)
library(tidyr)
library(purrr)
library(stringr)

# to wrangle models
source("code/fun_model_estimate_collection.r")
source("code/fun_make_resp_data.r")

# nice tables
library(knitr)
library(kableExtra)

# plotting
library(ggplot2)
library(patchwork)
source("code/fun_plot_interaction.r")
```

## Read species trait data and the final list of species

```{r eval=FALSE}
# list of species
species <- read_csv("data/species_list.csv")
list_of_species <- as.character(species$scientific_name)

# trait data
species_trait <- read_excel("data/species-trait-dat-ver01.xlsx")
```

## Show AIC weights

### Read in weight data

```{r}
# which files to read
file_names <- c("data/results/occu-2.5km/occuCovs/modelImp/lc-clim-imp.xlsx")

# read in sheets by species
model_imp <- map(file_names, function(f) {
  md_list <- map(list_of_species, function(sn) {
    
    # some sheets are not found
    
    tryCatch({
      
      readxl::read_excel(f, sheet = sn) %>% 
        `colnames<-`(c("predictor", "AIC_weight")) %>% 
        filter(str_detect(predictor, "psi")) %>% 
        mutate(predictor = stringr::str_extract(predictor, 
                                pattern = stringr::regex("\\((.*?)\\)")),
               predictor = stringr::str_replace_all(predictor, "[//(//)]", ""),
               predictor = stringr::str_remove(predictor, "\\.y"))
      
      },
      error = function(e) {
        message(as.character(e))
      }
    )
  })
  names(md_list) <- list_of_species
  
  return(md_list)
})
```

Sheets for one laughingthrush _Montecincla fairbankii_ and one barbet _Psilopogon viridis_ are not found at both scales.

### Show cumulative weights as plot

```{r}
# assign scale
names(model_imp) <- c("2.5km")
model_imp <- imap(model_imp, function(.x, .y) {
  .x <- bind_rows(.x)
  .x$scale <- .y
  return(.x)
})

# bind rows
model_imp <- map(model_imp, bind_rows) %>% 
  bind_rows()

# convert to numeric
model_imp$AIC_weight <- as.numeric(model_imp$AIC_weight)
model_imp$scale <- as.factor(model_imp$scale)
levels(model_imp$scale) <- c("2.5km")

# summ by scale and predictor
model_imp <- group_by(model_imp, predictor, scale) %>% 
  summarise(AIC_weight_cumulative = sum(AIC_weight))
```

```{r}
predictor_name <- c("Temp" = "Mean annual temp.",
                    "Ppt" = "Mean annual ppt.",
                    "LC 1" = "% agriculture",
                    "LC 2" = "% forests",
                    "LC 3" = "% plantations",
                    "LC 4" = "% settlements",
                    "LC 5" = "% tea",
                    "LC 6" = "% water bodies")
```

### Make plot

```{r}
ggplot(model_imp)+
  geom_point(aes(predictor, AIC_weight_cumulative),
             size = 3,
           position = position_dodge(width = 0.5),
           shape = 21)+
  geom_col(aes(predictor, AIC_weight_cumulative,
               fill = scale),
           colour = NA,
           width = 0.05,
           alpha = 0.5,
           position = position_dodge(width = 0.5))+
  scale_y_continuous(breaks = seq(45, 75, 10))+
  scale_x_discrete(labels = names(predictor_name))+
  # scale_color_brewer(palette = "RdBu", values = c(0.5, 1))+
  scale_fill_brewer(palette = "BuPu")+
  coord_cartesian(ylim = c(45, 75))+
  theme_test(base_size = 10)+
  theme(legend.position = "none")+
  labs(x = "Predictor",
       y = "Cumulative AIC weight")

ggsave("figs/fig_aic_weight.png", dpi = 300,
       width = 4, height = 4)
```

![Cumulative AIC weights for each predictor, where _Temp_ is the mean annual temperature, _Ppt_ is the mean annual precipitation, and LC 1 -- LC 6 are the proportions of agriculture, forest, plantation, settlement, tea, and water bodies, respectively."](figs/fig_aic_weight.png)

## Read model estimates

```{r read_model_estimates, eval=FALSE}
file_read <- c("data/results/occu-2.5km/occuCovs/modelEst/lc-clim-modelEst.xlsx")

# read data as list column
model_est <- map(file_read, function(fr) {
  md_list <- map(list_of_species, function(sn) {
    readxl::read_excel(fr, sheet = sn)
  })
  names(md_list) <- list_of_species
  
  return(md_list)
})

# prepare model data
scales = c("2.5km")
model_data <- tibble(crossing(scale = scales, 
                              scientific_name = list_of_species)) %>% 
  arrange(desc(scale))

# rename model data components and separate predictors
names <- c("predictor", "coefficient", "se", "ci_lower", 
           "ci_higher", "z_value", "p_value")

# get data for plotting:
model_est <- map(model_est, function(l) {
  map(l, function(df) {
    colnames(df) <- names
    df <- separate_interaction_terms(df)
    df <- make_response_data(df) 
    return(df)
  })
})

# add names and scales
model_est <- map(model_est, function(l) {
  imap(l, function(.x, .y) {
    mutate(.x, scientific_name = .y)
  })
})

# add names to model estimates
names(model_est) <- scales
model_est <- imap(model_est, function(.x, .y) {
  bind_rows(.x) %>% 
    mutate(scale = .y)
})

# remove modulators
model_est <- bind_rows(model_est) %>% 
  select(-matches("modulator"))

# join data to species name
model_data <- model_data %>% 
  left_join(model_est)
```

### Export data to file

Export predictor effects.

```{r}
# get predictor effect data
data_predictor_effect <- distinct(model_data, 
                                  scientific_name, 
                                  se,
                                  predictor, coefficient)

# write to file
write_csv(data_predictor_effect,
          path = "data/results/data_predictor_effect.csv")
```

Export model data.

```{r}
model_data_to_file <- model_data %>% 
  select(predictor, data,
         scientific_name, scale) %>% 
  unnest(cols = "data")

# remove .y
model_data_to_file <- model_data_to_file %>% 
  mutate(predictor = str_remove(predictor, "\\.y"))

write_csv(model_data_to_file,
          "data/results/data_occupancy_predictors.csv")
```

## Occupancy coefficients in relation with species traits

How do species' traits relate with the coefficient of each predictor of occupancy?

First get the saved model data and add trait data.

```{r}
# read from file
model_data <- read_csv("data/results/data_predictor_effect.csv")

# add weight as inverse of standard error
model_data$weight <- 1 / model_data$se
```

```{r}
# add trait by joining
model_data <- model_data %>% 
  left_join(species_trait, by = "scientific_name")

# remove orders which only have 2 species or fewer
# model_data <- model_data %>% 
#   group_by(order) %>% 
#   mutate(order_count = length(unique(scientific_name))) %>% 
#   ungroup() %>% 
#   filter(order_count > 3, !is.na(order)) %>% 
#   select(-order_count)

# count order again
model_data %>% 
  count(order, wt = length(unique(scientific_name)))

# rename because of course
model_data <- rename(model_data, mass = "Body mass", niche = "TrophicNiche")

# fix variable classes
model_data$order <- as.factor(model_data$order)
model_data$niche <- as.factor(model_data$niche)
```

### Split data by predictor

```{r}
# nest by predictor name
model_data <- model_data %>% 
  group_by(predictor) %>% 
  nest()
```

### Set up the models

```{r}
# trait models
library(lmerTest)
model_data$model <- map(model_data$data, function(df) {
  lmer(coefficient ~ HWI + mass + (1|niche), 
        weights = weight, 
        data = df)
})
```

```{r}
walk2(model_data$predictor, model_data$model, function(pred, mod) {
  mod_out <- capture.output(pred, summary(mod))
  # save it to file
  write_lines(x = mod_out,
              path = "data/results/model_output_coeff.txt", 
              append = TRUE)
})
```
