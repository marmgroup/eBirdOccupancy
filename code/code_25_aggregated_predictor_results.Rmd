---
editor_options: 
  chunk_output_type: console
---

# Results: Occupancy predictors

## Prepare libraries

```{r load_libs_results02, eval=FALSE}
# to load data
library(readxl)

# to handle data
library(dplyr)
library(readr)
library(forcats)
library(tidyr)
library(purrr)
library(stringr)
library(ggthemes)

# to wrangle models
source("code/fun_model_estimate_collection.r")
source("code/fun_make_resp_data.r")

# plotting
library(ggplot2)
library(patchwork)
source('code/fun_plot_interaction.r')
```

## Get data from hypothesis sheet

```{r eval=FALSE}
# read in the excel sheet containing information on the best supported hypothesis
sheet_names <- readxl::excel_sheets("C:\\Occupancy Runs\\all_hypoComparisons_allScales.xlsx")
which_sheet <- which(str_detect(sheet_names, "Best"))

hypothesis_data <- readxl::read_excel("C:\\Occupancy Runs\\all_hypoComparisons_allScales.xlsx",
                                      sheet = sheet_names[which_sheet])

# pivot longer
hypothesis_data <- pivot_longer(hypothesis_data,
                                cols = contains("Best"),
                                names_to = "scale", values_to = "hypothesis")
# fix scale to numeric
hypothesis_data <- mutate(hypothesis_data,
                          scale = if_else(str_detect(scale, "10"), "10km", "2.5km"))

# list the supported hypotheses
# first separate the hypotheses into two columns
hypothesis_data <- separate(hypothesis_data, col = hypothesis, sep = "; ", 
                            into = c("hypothesis_01", "hypothesis_02"),
                            fill = "right") %>% 
  # then get the data into long format
  pivot_longer(cols = c("hypothesis_01","hypothesis_02"),
               values_to = "hypothesis") %>% 
  # remove NA where there is only one hypothesis
  drop_na() %>% 
  # remove the name column
  select(-name)

# correct the name landCover to lc
hypothesis_data <- mutate(hypothesis_data,
                          hypothesis = replace(hypothesis,
                                               hypothesis %in% c("landCover", "climate",
                                                                 "elevation"), 
                                               c("lc","clim","elev")))

```

## Read model estimates

```{r read_model_estimates, eval=FALSE}
# which file to read model estimates from
hypothesis_data <- mutate(hypothesis_data,
                          file_read = glue::glue('C:\\Occupancy Runs\\Results_{scale}\\occuCovs\\modelEst\\{hypothesis}_modelEst.xlsx'))
                                                
# read in data as list column
model_data <- mutate(hypothesis_data,
                     model_est = map2(file_read, Scientific_name, function(fr, sn){
                       readxl::read_excel(fr, sheet = sn)
                     }))

# rename model data components and separate predictors
names <- c("predictor", "coefficient", "se", "ci_lower", "ci_higher", "z_value", "p_value")

# get data for plotting: separate the interaction terms and make the response df
model_data <- mutate(model_data, 
                     model_est = map(model_est, function(df){
  colnames(df) <- names
  df <- separate_interaction_terms(df)
  df <- make_response_data(df)
  return(df)
}))

# keep significant predictors
model_data <- model_data[map_int(model_data$model_est, nrow) > 0,]

# remove filename
model_data <- select(model_data, -file_read) %>% 
  unnest(model_est) %>%
  unnest(data)


```

## Occupancy predictors' aggregated effect

The various plots include: 
1. Predictors as a function of Range-restricted/Wide-ranging species
2. Predictors as a function of Open country/Forest species
3. Predictors as a function of Foraging location - canopy/mid-storey/shrub/understorey

Plot the number of species affected and the direction of the effect, for each predictor.

1. Creating a plot that shows range-restricted and wide-ranging species
```{r mirror_bar_plot, eval=FALSE}
# select the data 
data_predictor_effect <- distinct(model_data, 
                         Scientific_name, scale, predictor, modulator, coefficient)

data_predictor_effect <- data_predictor_effect %>%
  mutate_all(~str_replace_na(., "")) %>%
  mutate(predictor_final = paste0(predictor,":",modulator,sep=""))

data_predictor_effect <- left_join(data_predictor_effect, hypothesis_data[,1:8],
                                   by  = "Scientific_name")

data_predictor_effect <- mutate(data_predictor_effect, species_distribution  =if_else(as.logical(`Range-Restricted`),                                              "range restricted", "wide ranging"))

# is the coeff positive? how many positive per scale per predictor?
data_predictor_effect <- mutate(data_predictor_effect, 
                       direction = coefficient > 0) %>% 
  count(scale, predictor_final, species_distribution, direction) %>% 
  mutate(mag = n * (if_else(direction, 1, -1)))

# wrangle data to get nice bars
data_predictor_effect <- data_predictor_effect %>% 
  select(-n) %>% 
  mutate(direction = ifelse(direction, "positive", "negative")) %>% 
  pivot_wider(values_from = "mag", names_from = "direction") %>% 
  mutate_at(vars(positive, negative),
            ~if_else(is.na(.),0, .))


# visualise the data
fig_predictor_effect <-
  ggplot(data_predictor_effect)+
  geom_hline(yintercept = 0,
             lty = 2, lwd = 0.2,
             col = "grey")+
  geom_col(aes(x = factor(predictor_final),
               y = positive,
               group = species_distribution,
               fill = interaction(species_distribution, positive > 0)),
           position = position_dodge2(preserve = "single"))+
  geom_col(aes(x = factor(predictor_final), y = negative,
               group = species_distribution,
               fill = interaction(species_distribution, negative > 0)),
           position = position_dodge2(preserve = "single")) +
    scico::scale_fill_scico_d(palette = "batlow",
                            begin = 0.2, end = 0.8,
                            direction = -1) +
  theme_test()+
  theme(legend.position = "none")+
  facet_grid(species_distribution~scale, labeller = label_both)+
  labs(x = "predictor", y = "species")+
  theme(axis.text.x = element_text(angle = 90))
  
fig_predictor_effect

# save plot
ggsave(fig_predictor_effect, filename = "figs/fig_predictor_effect.png",
       dpi = 300)
```

2. Creating a plot that shows open-country and forest species
```{r mirror_bar_plot, eval=FALSE}
# select the data 
data_predictor_effect <- distinct(model_data, 
                         Scientific_name, scale, predictor, modulator, coefficient)

data_predictor_effect <- data_predictor_effect %>%
  mutate_all(~str_replace_na(., "")) %>%
  mutate(predictor_final = paste0(predictor,":",modulator,sep=""))

data_predictor_effect <- left_join(data_predictor_effect, hypothesis_data[,1:8],
                                   by  = "Scientific_name")

# is the coeff positive? how many positive per scale per predictor?
data_predictor_effect <- mutate(data_predictor_effect, 
                       direction = coefficient > 0) %>% 
  count(scale, predictor_final,`Habitat (Open Country / Forest )`, direction) %>% 
  mutate(mag = n * (if_else(direction, 1, -1)))

# wrangle data to get nice bars
data_predictor_effect <- data_predictor_effect %>% 
  select(-n) %>% 
  mutate(direction = ifelse(direction, "positive", "negative")) %>% 
  pivot_wider(values_from = "mag", names_from = "direction") %>% 
  mutate_at(vars(positive, negative),
            ~if_else(is.na(.),0, .))

names(data_predictor_effect)[3] <- "Habitat"

# visualise the data
fig_predictor_effect <-
  ggplot(data_predictor_effect)+
  geom_hline(yintercept = 0,
             lty = 2, lwd = 0.2,
             col = "grey")+
  geom_col(aes(x = factor(predictor_final),
               y = positive,
               group = Habitat,
               fill = interaction(Habitat, positive > 0)),
           position = position_dodge2(preserve = "single"))+
  geom_col(aes(x = factor(predictor_final), y = negative,
               group = Habitat,
               fill = interaction(Habitat, negative > 0)),
           position = position_dodge2(preserve = "single")) +
    scico::scale_fill_scico_d(palette = "batlow",
                            begin = 0.2, end = 0.8,
                            direction = -1) +
  theme_test()+
  theme(legend.position = "none")+
  facet_grid(Habitat~scale, labeller = label_both)+
  labs(x = "predictor", y = "species")+
  theme(axis.text.x = element_text(angle = 90))
  
fig_predictor_effect

# save plot
ggsave(fig_predictor_effect, filename = "figs/fig_predictor_effect.png",
       dpi = 300)
```

3. Creating a plot that shows shrub, midstorey, understorey and canopy species
```{r mirror_bar_plot, eval=FALSE}
# select the data 
data_predictor_effect <- distinct(model_data, 
                         Scientific_name, scale, predictor, modulator, coefficient)

data_predictor_effect <- data_predictor_effect %>%
  mutate_all(~str_replace_na(., "")) %>%
  mutate(predictor_final = paste0(predictor,":",modulator,sep=""))

data_predictor_effect <- left_join(data_predictor_effect, hypothesis_data[,1:8],
                                   by  = "Scientific_name")

# is the coeff positive? how many positive per scale per predictor?
data_predictor_effect <- mutate(data_predictor_effect, 
                       direction = coefficient > 0) %>% 
  count(scale, predictor_final,`Foraging Space (Canopy / Mid-storey / Terrestrial / Shrub)`, direction) %>% 
  mutate(mag = n * (if_else(direction, 1, -1)))

# wrangle data to get nice bars
data_predictor_effect <- data_predictor_effect %>% 
  select(-n) %>% 
  mutate(direction = ifelse(direction, "positive", "negative")) %>% 
  pivot_wider(values_from = "mag", names_from = "direction") %>% 
  mutate_at(vars(positive, negative),
            ~if_else(is.na(.),0, .))

names(data_predictor_effect)[3] <- "foraging space"

# visualise the data
fig_predictor_effect <-
  ggplot(data_predictor_effect)+
  geom_hline(yintercept = 0,
             lty = 2, lwd = 0.2,
             col = "grey")+
  geom_col(aes(x = factor(predictor_final),
               y = positive,
               group = `foraging space`,
               fill = interaction(`foraging space`, positive > 0)),
           position = position_dodge2(preserve = "single"))+
  geom_col(aes(x = factor(predictor_final), y = negative,
               group = `foraging space`,
               fill = interaction(`foraging space`, negative > 0)),
           position = position_dodge2(preserve = "single")) +
    scico::scale_fill_scico_d(palette = "batlow",
                            begin = 0.2, end = 0.8,
                            direction = -1) +
  theme_test()+
  theme(legend.position = "none")+
  facet_grid(`foraging space`~scale, labeller = label_both)+
  labs(x = "predictor", y = "species")+
  theme(axis.text.x = element_text(angle = 90))
  
fig_predictor_effect

# save plot
ggsave(fig_predictor_effect, filename = "figs/fig_predictor_effect.png",
       dpi = 300)
```

A plot of elevational ranges of presence points and predictors 
```{r}
# load data
elev_data <- list.files(path = "C:\\Occupancy Runs\\",
                   pattern = "elevation",
                   full.names = TRUE)
elev_data <- lapply(elev_data, readxl::read_excel)


# prepare data
elev_data <- elev_data %>% 
  bind_rows() %>% 
  arrange(median) %>% 
  mutate(plot_order = 1:length(median)) %>% 
  ungroup() 

# select the data 
data_predictor_effect <- distinct(model_data, 
                         Scientific_name, scale, predictor, modulator, coefficient)

data_predictor_effect <- left_join(data_predictor_effect, elev_data,
                                   by  = c("Scientific_name"="Species"))

# plot positions of predictor code
data_pred <- count(data_predictor_effect, scale, predictor) %>%
  group_by(scale) %>% 
  mutate(plot_pos = cumsum(n)) %>% 
  ungroup() %>% 
  mutate(predictor = as_factor(predictor),
         plot_letter = letters[as.numeric(predictor)])

# make figure
fig_hypothesis_elev <- 
  ggplot(data_predictor_effect, aes(x = plot_order, y = median,
                   col = predictor))+
  geom_hline(yintercept = c(700,1400),
             lty = 2, size = 0.2)+
  geom_errorbar(width = 0.4,
                aes(ymin = q1, ymax = q3,))+
  geom_point(aes(fill = predictor),
             shape = 21, col = "grey20")+
  geom_text(aes(label = Scientific_name), 
            size = 2.5,
            fontface = "italic",
            nudge_x = 0.4, col = "black")+
  geom_text(data = data_pred,
            aes(x = plot_pos, y = 2250,
                label = plot_letter),
            col = "grey20", fontface = "bold")+
  geom_vline(data = data_pred,
             aes(xintercept = plot_pos + 0.5),
             lty = 3, lwd = 0.4, col = "grey")+
  scale_color_hue(l = 50, c = 50)+
  scale_fill_hue(l = 70)+
  theme_few()+
  theme(legend.position = "none",
        legend.key = element_rect(colour = "white",
                                  size = 0.3),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())+
  labs(y = "elevation (m)", x = "Species",
       colour = "Significant predictor")+
  coord_flip()+
  facet_wrap(~scale+predictor, labeller = label_both)

fig_hypothesis_elev

```



```{r show_reverse_bar, eval=TRUE}
knitr::include_graphics("figs/fig_predictor_effect.png")
```
