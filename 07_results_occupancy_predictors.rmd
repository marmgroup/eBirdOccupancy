---
editor_options: 
  chunk_output_type: console
---

# Results: Occupancy predictors

## Prepare libraries

```{r load_libs_results02, eval=FALSE}
# to load data
library(readxl)

# to handle data
library(dplyr)
library(readr)
library(forcats)
library(tidyr)
library(purrr)
library(stringr)

# to wrangle models
source("code/fun_model_estimate_collection.r")
source("code/fun_make_resp_data.r")

# plotting
library(ggplot2)
library(patchwork)
source('code/fun_plot_interaction.r')
```

## Get data from hypothesis sheet

```{r eval=FALSE}
# read in the excel sheet containing information on the best supported hypothesis
sheet_names <- readxl::excel_sheets("data/results/all_hypoComparisons_allScales.xlsx")
which_sheet <- which(str_detect(sheet_names, "Best"))

hypothesis_data <- readxl::read_excel("data/results/all_hypoComparisons_allScales.xlsx",
                                      sheet = sheet_names[which_sheet])

# Subsetting the data needed to call in each species' model coefficient information
hypothesis_data <- select(hypothesis_data,
                          Scientific_name, Common_name,
                          contains("Best supported hypothesis"))

# pivot longer
hypothesis_data <- pivot_longer(hypothesis_data,
                                cols = contains("Best"),
                                names_to = "scale", values_to = "hypothesis")
# fix scale to numeric
hypothesis_data <- mutate(hypothesis_data,
                          scale = if_else(str_detect(scale, "10"), "10km", "2.5km"))

# list the supported hypotheses
# first separate the hypotheses into two columns
hypothesis_data <- separate(hypothesis_data, col = hypothesis, sep = "; ", 
                            into = c("hypothesis_01", "hypothesis_02"),
                            fill = "right") %>% 
  # then get the data into long format
  pivot_longer(cols = c("hypothesis_01","hypothesis_02"),
               values_to = "hypothesis") %>% 
  # remove NA where there is only one hypothesis
  drop_na() %>% 
  # remove the name column
  select(-name)

# correct the name landCover to lc
hypothesis_data <- mutate(hypothesis_data,
                          hypothesis = replace(hypothesis,
                                               hypothesis %in% c("landCover", "climate",
                                                                 "elevation"), 
                                               c("lc","clim","elev")))
```

## Read model estimates

```{r read_model_estimates, eval=FALSE}
# which file to read model estimates from
hypothesis_data <- mutate(hypothesis_data,
                          file_read = glue::glue('data/results/Results_{scale}/occuCovs/modelEst/{hypothesis}_modelEst.xlsx'))

# read in data as list column
model_data <- mutate(hypothesis_data,
                     model_est = map2(file_read, Scientific_name, function(fr, sn){
                       readxl::read_excel(fr, sheet = sn)
                     }))

# rename model data components and separate predictors
names <- c("predictor", "coefficient", "se", "ci_lower", "ci_higher", "z_value", "p_value")

# get data for plotting: separate the interaction terms and make the response df
model_data <- mutate(model_data, 
                     model_est = map(model_est, function(df){
  colnames(df) <- names
  df <- separate_interaction_terms(df)
  df <- make_response_data(df)
  return(df)
}))

# keep significant predictors
model_data <- model_data[map_int(model_data$model_est, nrow) > 0,]

# remove filename
model_data <- select(model_data, -file_read) %>% 
  unnest(model_est) %>% 
  unnest(data)
```

Elevation always varies between 0 to 2625m
Landcover predictors are proportions - so 0 to 1
But climate varies:

prec_interannual: 0 to 300
temp_interannual: 0 to 50
bio_17: 0 to 80
bio_18: 0 to 300

## Prepare interaction plots

Select useful columns and split by scale. Hypothesis can be shape?
Facet is predictor. Patchwork is scale.

```{r prep_figures_interaction, eval=FALSE}
# select useful columns
plot_data <- select(model_data, 
                   Scientific_name, Common_name,
                   scale, hypothesis,
                   predictor, modulator, m_group, seq_x, mean, ci)

# nest at the scale level and ungroup
plot_data <- group_by(plot_data, 
                      scale) %>%
  nest() %>% 
  ungroup()

# test plot
temp_plot <- function(df){
  ggplot(df, 
       aes(seq_x, mean, col = m_group,
                shape = hypothesis,
                group = interaction(Scientific_name, hypothesis,
                                    m_group)))+
  geom_line(show.legend = FALSE,
            size = 0.3)+
  geom_ribbon(aes(ymin = mean-ci, ymax = mean+ci,
                  fill = m_group),
                  alpha= 0.3, col = NA)+
  
  scale_colour_manual(values = c("grey", "dodgerblue", "indianred"))+
  scale_fill_manual(values = c("grey", "dodgerblue", "indianred"))+
  theme_test(base_size = 8,
             base_family = "Arial")+
  theme(legend.position = "top")+
  guides(colour = guide_legend(nrow = 1))+
  facet_wrap(~predictor, scales = "free_x",
             nrow = 2, strip.position = "bottom")+
  labs(x = NULL, y = "p(occupancy)")
}

# make plots
plot_data$plot <- map(plot_data$data, temp_plot)

# make patchwork
temp_plots <- wrap_plots(plot_data$plot)

temp_plots
```

```{r eval=FALSE}
fig_list <- pmap(plot_data, 
                 function(Common_name, Scientific_name, scale, hypothesis, figures){
  final_plot <- wrap_plots(figures, ncol = 7)+
    patchwork::plot_annotation(
      title = glue::glue('{Common_name} ({Scientific_name})'),
      subtitle = glue::glue('scale: {scale}, best supported hypothesis: {hypothesis}'),
      tag_levels = "a",
      tag_prefix = "(", tag_suffix = ")",
      theme = theme(plot.title = element_text(size = 10, face = "bold")))
  
  return(final_plot)
})
```

```{r make_interactions_pdf, eval=FALSE}
# make pdf of patchwork
cairo_pdf(file = "figs/fig_occupancy.pdf", width = 10, height = 3,
          onefile = TRUE)
{
  print(fig_list)
}
dev.off()
```

## Show example interaction

```{r show_one_species, eval=TRUE, fig.height=8}
library(magick)
fig_interaction = image_read_pdf("figs/fig_occupancy.pdf", pages = 86)
fig_interaction
```

## Occupancy predictors' aggregated effect

Read in the species as range restricted or wide ranging. We previously identified the sheet.

```{r}
hypothesis_data <- readxl::read_excel("data/results/all_hypoComparisons_allScales.xlsx",
                                      sheet = sheet_names[which_sheet])
```


Plot the number of species affected and the direction of the effect, for each predictor.
Split the data along the axes of range restriction, large scale habitat type, and small scale habitat type.

```{r mirror_bar_plot, eval=FALSE}
# select the data
data_predictor_effect <- distinct(model_data, 
                         Scientific_name, scale, 
                         predictor, modulator, coefficient)

# add the species distribution
data_predictor_effect <- left_join(data_predictor_effect, hypothesis_data,
                                   by  = c("Scientific_name" = "Scientific_name"))

# rename columns and make text 'nice'
data_predictor_effect <- mutate(data_predictor_effect,
                                distribution = if_else(as.logical(`Range-Restricted`),
                                                               "range restricted",
                                                               "wide ranging"),
                                habitat = str_to_lower(`Habitat (Open Country / Forest )`),
                                storey = str_to_lower(`Foraging Space (Canopy / Mid-storey / Terrestrial / Shrub)`),
                                body_mass = `Body Mass (g)`
                                )

# remove old cols and set nice column names
data_predictor_effect <- select(data_predictor_effect,
                                -contains(c(" ", "-")))
# convert colnames to lower case
data_predictor_effect <- data_predictor_effect %>% 
  `colnames<-`(str_to_lower(colnames(.)))

# remove .y from predictors
data_predictor_effect <- data_predictor_effect %>%
  mutate_if(is.character, .funs = function(x){
    stringr::str_remove(x, ".y")
  }) %>%
  
  # remove the ":NA"
  mutate(predictor_final = glue('{predictor}:{modulator}'),
         predictor_final = str_remove(predictor_final, ":NA"))

# now remove predictor and modulator
data_predictor_effect <- select(data_predictor_effect,
                                -predictor, -modulator)
```

What is the direction of the predictor effect for each subset of the data by the distribution, habitat, diet, and storey?

```{r}
# first pivot the data longer
data_predictor_effect <- data_predictor_effect %>% 
  pivot_longer(cols = c("diet", "distribution", "habitat", "storey"), 
               names_to = "trait")


# is the coeff positive? how many positive per scale per predictor per axis of split?
data_predictor_effect <- mutate(data_predictor_effect, 
                                direction = coefficient > 0) %>% 
  count(scale, predictor_final, 
        trait, value, direction) %>% 
  mutate(mag = n * (if_else(direction, 1, -1)))

# wrangle data to get nice bars
data_predictor_effect <- data_predictor_effect %>% 
  select(-n) %>% 
  mutate(direction = ifelse(direction, "positive", "negative")) %>% 
  pivot_wider(values_from = "mag", names_from = "direction") %>% 
  mutate_at(vars(positive, negative),
            ~if_else(is.na(.),0, .))

# nest the data by trait
data_predictor_effect <- data_predictor_effect %>% nest(data = -trait)
```

```{r}
# visualise the data by mapping over the nested list
data_predictor_effect <- mutate(data_predictor_effect,
                                figs = map2(data, trait, function(df, tr){
                                  ggplot(df)+
                                    geom_hline(yintercept = 0,
                                               lty = 2, lwd = 0.2,
                                               col = "grey")+
                                    geom_col(aes(x = factor(predictor_final),
                                                 y = positive,
                                                 group = value,
                                                 fill = interaction(value, positive > 0)),
                                             position = position_dodge2(preserve = "single"))+
                                    geom_col(aes(x = factor(predictor_final),
                                                 y = negative,
                                                 group = value,
                                                 fill = interaction(value, negative > 0)),
                                             position = position_dodge2(preserve = "single"))+
                                    scico::scale_fill_scico_d(palette = "hawaii",
                                                              begin = 0.2, end = 0.8,
                                                              direction = 1)+
                                    
                                    scale_x_discrete(guide = guide_axis(n.dodge = 2),
                                                     label = 1:length(unique(df$predictor_final)))+
                                    
                                    theme_test(base_size = 6)+
                                    theme(legend.position = "none")+
                                    facet_grid(scale~value, labeller = label_both)+
                                    labs(x = "predictor", y = "species",
                                         title = glue('species split by {tr}'),
                                         caption = "the X axis text overlaps, consider numbers - pg")
                                }))

fig_predictor_effect <- patchwork::wrap_plots(data_predictor_effect$figs,
                                              nrow = 2)
# save plot
ggsave(fig_predictor_effect, filename = "figs/fig_predictor_effect.png",
       dpi = 300)
```

```{r show_reverse_bar, eval=TRUE}
knitr::include_graphics("figs/fig_predictor_effect.png")
```

## Habitat type and predictor effects

```{r hbaitat_type, eval=FALSE}
# select the data 
data_predictor_effect <- distinct(model_data, 
                                  Scientific_name, scale, 
                                  predictor, modulator, coefficient)



# join to species data
data_predictor_effect <- left_join(data_predictor_effect, 
                                   hypothesis_data,
                                   by  = "Scientific_name")

# is the coeff positive? how many positive per scale per predictor?
data_predictor_effect <- mutate(data_predictor_effect, 
                                direction = coefficient > 0) %>% 
  count(scale, predictor_final,`Habitat (Open Country / Forest )`, direction) %>% 
  mutate(mag = n * (if_else(direction, 1, -1)))

# wrangle data to get nice bars
data_predictor_effect <- data_predictor_effect %>% 
  select(-n) %>% 
  mutate(direction = ifelse(direction, "positive", "negative")) %>% 
  pivot_wider(values_from = "mag", names_from = "direction") %>% 
  mutate_at(vars(positive, negative),
            ~if_else(is.na(.),0, .))

names(data_predictor_effect)[3] <- "Habitat"

# visualise the data
fig_predictor_effect <-
  ggplot(data_predictor_effect)+
  geom_hline(yintercept = 0,
             lty = 2, lwd = 0.2,
             col = "grey")+
  geom_col(aes(x = factor(predictor_final),
               y = positive,
               group = Habitat,
               fill = interaction(Habitat, positive > 0)),
           position = position_dodge2(preserve = "single"))+
  geom_col(aes(x = factor(predictor_final), y = negative,
               group = Habitat,
               fill = interaction(Habitat, negative > 0)),
           position = position_dodge2(preserve = "single")) +
    scico::scale_fill_scico_d(palette = "batlow",
                            begin = 0.2, end = 0.8,
                            direction = -1) +
  theme_test()+
  theme(legend.position = "none")+
  facet_grid(Habitat~scale, labeller = label_both)+
  labs(x = "predictor", y = "species")+
  theme(axis.text.x = element_text(angle = 90))
```

3. Creating a plot that shows shrub, midstorey, understorey and canopy species
```{r mirror_bar_plot, eval=FALSE}
# select the data 
data_predictor_effect <- distinct(model_data, 
                         Scientific_name, scale, predictor, modulator, coefficient)

data_predictor_effect <- data_predictor_effect %>%
  mutate_all(~str_replace_na(., "")) %>%
  mutate(predictor_final = paste0(predictor,":",modulator,sep=""))

data_predictor_effect <- left_join(data_predictor_effect, hypothesis_data[,1:8],
                                   by  = "Scientific_name")

# is the coeff positive? how many positive per scale per predictor?
data_predictor_effect <- mutate(data_predictor_effect, 
                       direction = coefficient > 0) %>% 
  count(scale, predictor_final,`Foraging Space (Canopy / Mid-storey / Terrestrial / Shrub)`, direction) %>% 
  mutate(mag = n * (if_else(direction, 1, -1)))

# wrangle data to get nice bars
data_predictor_effect <- data_predictor_effect %>% 
  select(-n) %>% 
  mutate(direction = ifelse(direction, "positive", "negative")) %>% 
  pivot_wider(values_from = "mag", names_from = "direction") %>% 
  mutate_at(vars(positive, negative),
            ~if_else(is.na(.),0, .))

names(data_predictor_effect)[3] <- "foraging space"

# visualise the data
fig_predictor_effect <-
  ggplot(data_predictor_effect)+
  geom_hline(yintercept = 0,
             lty = 2, lwd = 0.2,
             col = "grey")+
  geom_col(aes(x = factor(predictor_final),
               y = positive,
               group = `foraging space`,
               fill = interaction(`foraging space`, positive > 0)),
           position = position_dodge2(preserve = "single"))+
  geom_col(aes(x = factor(predictor_final), y = negative,
               group = `foraging space`,
               fill = interaction(`foraging space`, negative > 0)),
           position = position_dodge2(preserve = "single")) +
    scico::scale_fill_scico_d(palette = "batlow",
                            begin = 0.2, end = 0.8,
                            direction = -1) +
  theme_test()+
  theme(legend.position = "none")+
  facet_grid(`foraging space`~scale, labeller = label_both)+
  labs(x = "predictor", y = "species")+
  theme(axis.text.x = element_text(angle = 90))
  
fig_predictor_effect

# save plot
ggsave(fig_predictor_effect, filename = "figs/fig_predictor_effect.png",
       dpi = 300)
```

A plot of elevational ranges of presence points and predictors 
```{r}
# load data
elev_data <- list.files(path = "C:\\Occupancy Runs\\",
                   pattern = "elevation",
                   full.names = TRUE)
elev_data <- lapply(elev_data, readxl::read_excel)

# prepare data
elev_data <- elev_data %>% 
  bind_rows() %>% 
  arrange(median) %>% 
  mutate(plot_order = 1:length(median)) %>% 
  ungroup() 

# select the data 
data_predictor_effect <- distinct(model_data, 
                         Scientific_name, scale, predictor, modulator, coefficient)

data_predictor_effect <- data_predictor_effect %>%
  mutate_all(~str_replace_na(., "")) %>%
  mutate(predictor_final = paste0(predictor,":",modulator,sep=""))

data_predictor_effect <- left_join(data_predictor_effect, elev_data,
                                   by  = c("Scientific_name"="Species"))

# Creating a synthetic variable 
data_predictor_effect <- data_predictor_effect %>%
  mutate(synthesis_var = if_else(
    str_detect(predictor_final, pattern = "lc_[0-9]+.y:$"), "Land Cover",
    if_else(str_detect(predictor_final, pattern = "lc_[0-9]+.y:alt.y"),"Land Cover*Elevation",if_else(str_detect(predictor_final, pattern = "alt.y:$"), "Elevation",
    if_else(str_detect(predictor_final, pattern = "temp_interannual.y:$"),"Climate",
    if_else(str_detect(predictor_final, pattern = "prec_interannual.y:$"),"Climate",
    if_else(str_detect(predictor_final, pattern = "bio_[0-9]+.y:$"), "Climate",
    if_else(str_detect(predictor_final, pattern = "prec_interannual.y:alt.y"), "Climate*Elevation",
    if_else(str_detect(predictor_final, pattern = "temp_interannual.y:alt.y"),"Climate*Elevation",
    if_else(str_detect(predictor_final, pattern = "bio_[0-9]+.y:alt.y"), "Climate*Elevation",
    if_else(str_detect(predictor_final, pattern = "slope.y:$"), "Elevation",
    if_else(str_detect(predictor_final, pattern = "aspect.y:$"), "Elevation","NA"))))))))))))

# plot positions of predictor code
data_pred <- count(data_predictor_effect, scale, synthesis_var) %>%
  group_by(scale) %>% 
  mutate(plot_pos = cumsum(n)) %>% 
  ungroup() %>% 
  mutate(synthesis_var = as_factor(synthesis_var),
         plot_letter = letters[as.numeric(synthesis_var)])

# make figure
fig_hypothesis_elev <- 
  ggplot(data_predictor_effect, aes(x = plot_order, y = median,
                   col = synthesis_var))+
  geom_hline(yintercept = c(700,1400),
             lty = 2, size = 0.2)+
  geom_errorbar(width = 0.4,
                aes(ymin = q1, ymax = q3,))+
  geom_point(aes(fill = synthesis_var),
             shape = 21, col = "grey20")+
  geom_text(aes(label = Scientific_name), 
            size = 2.5,
            fontface = "italic",
            nudge_x = 0.4, col = "black")+
  geom_text(data = data_pred,
            aes(x = plot_pos, y = 2250,
                label = plot_letter),
            col = "grey20", fontface = "bold")+
  geom_vline(data = data_pred,
             aes(xintercept = plot_pos + 0.5),
             lty = 3, lwd = 0.4, col = "grey")+
  scale_color_hue(l = 50, c = 50)+
  scale_fill_hue(l = 70)+
  theme_few()+
  theme(legend.position = "none",
        legend.key = element_rect(colour = "white",
                                  size = 0.3),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())+
  labs(y = "elevation (m)", x = "Species",
       colour = "synthesis_var")+
  coord_flip()+
  facet_wrap(~scale, labeller = label_both)

fig_hypothesis_elev

```



```{r show_reverse_bar, eval=TRUE}
knitr::include_graphics("figs/fig_predictor_effect.png")
```
