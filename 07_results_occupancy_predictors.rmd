---
editor_options: 
  chunk_output_type: console
---

# Results: Occupancy predictors

## Prepare libraries

```{r load_libs_results02, eval=FALSE}
# to load data
library(readxl)

# to handle data
library(dplyr)
library(readr)
library(forcats)
library(tidyr)
library(purrr)
library(stringr)

# to wrangle models
source("code/fun_model_estimate_collection.r")
source("code/fun_make_resp_data.r")

# plotting
library(ggplot2)
library(patchwork)
source('code/fun_plot_interaction.r')
```

## Get data from hypothesis sheet

```{r eval=FALSE}
# read in the excel sheet containing information on the best supported hypothesis
sheet_names <- readxl::excel_sheets("data/results/all_hypoComparisons_allScales.xlsx")
which_sheet <- which(str_detect(sheet_names, "Best"))

hypothesis_data <- readxl::read_excel("data/results/all_hypoComparisons_allScales.xlsx",
                                      sheet = sheet_names[which_sheet])

# Subsetting the data needed to call in each species' model coefficient information
hypothesis_data <- select(hypothesis_data,
                          Scientific_name, Common_name,
                          contains("Best supported hypothesis"))

# pivot longer
hypothesis_data <- pivot_longer(hypothesis_data,
                                cols = contains("Best"),
                                names_to = "scale", values_to = "hypothesis")
# fix scale to numeric
hypothesis_data <- mutate(hypothesis_data,
                          scale = if_else(str_detect(scale, "10"), "10km", "2.5km"))

# list the supported hypotheses
# first separate the hypotheses into two columns
hypothesis_data <- separate(hypothesis_data, col = hypothesis, sep = "; ", 
                            into = c("hypothesis_01", "hypothesis_02"),
                            fill = "right") %>% 
  # then get the data into long format
  pivot_longer(cols = c("hypothesis_01","hypothesis_02"),
               values_to = "hypothesis") %>% 
  # remove NA where there is only one hypothesis
  drop_na() %>% 
  # remove the name column
  select(-name)

# correct the name landCover to lc
hypothesis_data <- mutate(hypothesis_data,
                          hypothesis = replace(hypothesis,
                                               hypothesis %in% c("landCover", "climate",
                                                                 "elevation"), 
                                               c("lc","clim","elev")))
```

## Read model estimates

```{r read_model_estimates, eval=FALSE}
# which file to read model estimates from
hypothesis_data <- mutate(hypothesis_data,
                          file_read = glue::glue('data/results/results_model_est_{scale}/{hypothesis}_modelEst.xlsx'))

# read in data as list column
model_data <- mutate(hypothesis_data,
                     model_est = map2(file_read, Scientific_name, function(fr, sn){
                       readxl::read_excel(fr, sheet = sn)
                     }))

# rename model data components and separate predictors
names <- c("predictor", "coefficient", "se", "ci_lower", "ci_higher", "z_value", "p_value")

# get data for plotting: separate the interaction terms and make the response df
model_data <- mutate(model_data, 
                     model_est = map(model_est, function(df){
  colnames(df) <- names
  df <- separate_interaction_terms(df)
  df <- make_response_data(df)
  return(df)
}))

# keep significant predictors
model_data <- model_data[map_int(model_data$model_est, nrow) > 0,]

# remove filename
model_data <- select(model_data, -file_read) %>% 
  unnest(model_est) %>% 
  unnest(data)
```

Elevation always varies between 0 to 2625m
Landcover predictors are proportions - so 0 to 1
But climate varies:

prec_interannual: 0 to 300
temp_interannual: 0 to 50
bio_17: 0 to 80
bio_18: 0 to 300

## Prepare interaction plots

Select useful columns and split by scale. Hypothesis can be shape?
Facet is predictor. Patchwork is scale.

```{r prep_figures_interaction, eval=FALSE}
# select useful columns
plot_data <- select(model_data, 
                   Scientific_name, Common_name,
                   scale, hypothesis,
                   predictor, modulator, m_group, seq_x, mean, ci)

# nest at the scale level and ungroup
plot_data <- group_by(plot_data, 
                      scale) %>%
  nest() %>% 
  ungroup()

# test plot
temp_plot <- function(df){
  ggplot(df, 
       aes(seq_x, mean, col = m_group,
                shape = hypothesis,
                group = interaction(Scientific_name, hypothesis,
                                    m_group)))+
  geom_line(show.legend = FALSE,
            size = 0.3)+
  geom_ribbon(aes(ymin = mean-ci, ymax = mean+ci,
                  fill = m_group),
                  alpha= 0.3, col = NA)+
  
  scale_colour_manual(values = c("grey", "dodgerblue", "indianred"))+
  scale_fill_manual(values = c("grey", "dodgerblue", "indianred"))+
  theme_test(base_size = 8,
             base_family = "Arial")+
  theme(legend.position = "top")+
  guides(colour = guide_legend(nrow = 1))+
  facet_wrap(~predictor, scales = "free_x",
             nrow = 2, strip.position = "bottom")+
  labs(x = NULL, y = "p(occupancy)")
}

# make plots
plot_data$plot <- map(plot_data$data, temp_plot)

# make patchwork
temp_plots <- wrap_plots(plot_data$plot)

temp_plots
```

```{r eval=FALSE}
fig_list <- pmap(plot_data, 
                 function(Common_name, Scientific_name, scale, hypothesis, figures){
  final_plot <- wrap_plots(figures, ncol = 7)+
    patchwork::plot_annotation(
      title = glue::glue('{Common_name} ({Scientific_name})'),
      subtitle = glue::glue('scale: {scale}, best supported hypothesis: {hypothesis}'),
      tag_levels = "a",
      tag_prefix = "(", tag_suffix = ")",
      theme = theme(plot.title = element_text(size = 10, face = "bold")))
  
  return(final_plot)
})
```

```{r make_interactions_pdf, eval=FALSE}
# make pdf of patchwork
cairo_pdf(file = "figs/fig_occupancy.pdf", width = 10, height = 3,
          onefile = TRUE)
{
  print(fig_list)
}
dev.off()
```

## Show example interaction

```{r show_one_species, eval=TRUE, fig.height=8}
library(magick)
fig_interaction = image_read_pdf("figs/fig_occupancy.pdf", pages = 86)
fig_interaction
```

## Occupancy predictors' aggregated effect

Plot the number of species affected and the direction of the effect, for each predictor.

```{r mirror_bar_plot, eval=FALSE}
# select the data
rev_bar_data <- distinct(model_data, 
                         Scientific_name, scale, predictor, coefficient)

# is the coeff positive? how many positive per scale per predictor?
rev_bar_data <- mutate(rev_bar_data, 
                       direction = coefficient > 0) %>% 
  count(scale, predictor, direction) %>% 
  mutate(mag = n * (if_else(direction, 1, -1)))

# visualise the data
fig_predictor_effect <-
  ggplot(rev_bar_data)+
  geom_col(aes(x = factor(predictor),
               y = mag,
               fill = direction))+
  scico::scale_fill_scico_d(palette = "lisbon",
                            begin = 0.2, end = 0.8,
                            direction = -1)+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme_test()+
  theme(legend.position = "none")+
  facet_wrap(~scale, labeller = label_both)+
  labs(x = "predictor", y = "# species")

# save plot
ggsave(fig_predictor_effect, filename = "figs/fig_predictor_effect.png",
       dpi = 300)
```

```{r show_reverse_bar, eval=TRUE}
knitr::include_graphics("figs/fig_predictor_effect.png")
```

