---
editor_options: 
  chunk_output_type: console
---

# Predicting species-specific occupancy as a function of significant predictors

This script plots species-specific probabilities of occupancy as a function of significant environmental predictors as well as coefficient plots. 

## Prepare libraries

```{r load_libs_results02}
# to handle data
library(dplyr)
library(readr)
library(tidyr)
library(purrr)
library(stringr)
library(glue)
# library(data.table)

# nice tables
library(knitr)
library(kableExtra)

# plotting
library(ggplot2)
library(patchwork)
```

## Read data

```{r}
# read coefficient effect data
data <- read_csv("data/results/data_predictor_effect.csv")
```

```{r}
# check for a predictor column
assertthat::assert_that(
  all(c("predictor", "coefficient", "se") %in% colnames(data)),
  msg = "make_response_data: data must have columns called 'predictor',
    'coefficient', and 'se'"
)

# data <- filter(
#   data
#   # p_value <= 0.05 | predictor == "Int"
# )
```

## Prepare predictor data

```{r}
# preparep predictors
predictors = c("bio4a", "bio15a", glue("lc_0{seq(9)}"))

# prepare predictor search strings and scaling power
preds = glue("({predictors})")
preds = str_flatten(preds, collapse = "|")
power = as.numeric(str_extract(data$predictor, "2"))
power[is.na(power)] = 1

# assign predictor name and power
data = mutate(
  data,
  predictor = str_extract(predictor, preds),
  power = power
)
```

## Get predictor responses

```{r}
# make predictor sequences
data = mutate(
  data,
  pred_val = map(
    predictor,
    function(x) { seq(0, 1, 0.05) }
  ),
  # handle squared terms
  pred_val_pow = purrr::map2(
    pred_val, power,
    function(x, y) {x^y}
  )
)

# get coefficient and error times terms
data_resp = mutate(
  data,
  response = map2(
    pred_val_pow, coefficient,
    function(x, y) {x * y}
  ),
  resp_var = map2(
    pred_val_pow, se,
    function(x, y) {x * y}
  )
)
```

## Get probability of occupancy

```{r}
# unnest and get responses
data_resp = unnest(
  data_resp, 
  cols = c("response", "resp_var", "pred_val")
)

# get responses for quadratic terms
data_resp =
  group_by(
  data_resp,
  scientific_name, predictor, pred_val
) %>% 
  select(-power, -coefficient, -se) %>% 
  summarise(
    across(
      .cols = c("response", "resp_var"),
      .fns = sum
    ), 
    .groups = "keep"
  )

# get probability of occupancy
data_resp = ungroup(
  data_resp
) %>% 
  mutate(
    p_occu = 1 / (1 + exp(-response)),
    p_occu_low = 1 / (1 + exp(-(response - resp_var))),
    p_occu_high = 1 / (1 + exp(-(response + resp_var)))
  )
```

## Add scaling for predictors

```{r}
# scale predictors
scale_15a = 40
scale_4a = 0.375

# scale bio4a and bio15a by actual values
data_resp = mutate(
  data_resp,
  pred_val = case_when(
    predictor == "bio4a" ~ pred_val * scale_4a,
    predictor == "bio15a" ~ pred_val * scale_15a,
    T ~ pred_val
  )
)

# make long
data_poccu = select(
  data_resp,
  -response, -resp_var
)
```

```{r}
# select species
soi = c("Culicicapa ceylonensis", "Irena puella", 
        "Copsychus fulicatus", "Pycnonotus jocosus")
which_predictors = c("bio4a")
```

### Figure: Occupancy ~ predictors

```{r}
data_fig = data_poccu %>% 
  filter(
    scientific_name %in% soi,
    predictor %in% which_predictors
  ) |> 
  mutate(
    cat = case_when(
      scientific_name %in% c("Irena puella", "Culicicapa ceylonensis") ~ "forest",
      T ~ "general"
    )
  )

# split data
data_fig = nest(
  data_fig,
  -cat
)
```


```{r}
# make plots
# fig_occu_var =
make_occu_fig = function(df, this_fill) {
  ggplot(
    df
  )+
  geom_ribbon(
    aes(
      pred_val,
      ymin = p_occu_low,
      ymax = p_occu_high
    ),
    fill = this_fill,
    alpha = 0.5
  )+
  geom_line(
    aes(
      pred_val, p_occu
    )
  )+
  facet_grid(
    ~scientific_name
  )+
  theme_test(
    base_family = "Arial"
  )+
  theme(
    strip.text = element_text(
      face = "italic"
    )
  )+
  labs(
   x = "Temperature seasonality",
   y = "Probability of occupancy"
  )
}


fig_occu = map2(data_fig$data, c("khaki", "seagreen"), make_occu_fig)

fig_occu = wrap_plots(
  fig_occu
) & plot_annotation(
  tag_levels = "A"
) &
  theme(
    plot.tag = element_text(
      face = "bold"
    )
  )
```

### Figures: Occupancy ~ predictors for all species

```{r}
data_fig = nest(
  data_poccu,
  -scientific_name, -predictor
)

pred_names = c(
  "bio4a" = "Temp. seasonality",
  "bio15a" = "Ppt. seasonality",
  "lc_01" = "Evergreen",
  "lc_02" = "Deciduous",
  "lc_03" = "Mixed/degraded",
  "lc_04" = "Agro./Settled",
  "lc_05" = "Grassland",
  "lc_07" = "Plantation",
  "lc_09" = "Water"
)
pred_names = tibble(
  name = pred_names,
  predictor = names(pred_names)
)
data_fig = left_join(
  data_fig,
  pred_names
)

data_fig = mutate(
  data_fig,
  plots = map(
    data, function(df) {
      ggplot(df)+
      geom_ribbon(
        aes(
          pred_val,
          ymin = p_occu_low,
          ymax = p_occu_high
        ),
        fill = "grey",
        alpha = 0.5
      )+
      geom_line(
        aes(
          pred_val, p_occu
        )
      )+
      coord_cartesian(
        ylim = c(0, 1)
      )+
      theme_test(
        base_family = "Arial"
      )+
      labs(
        x = "Predictor",
        y = "p(Occupancy)"
      )
    }
  )
)

# add names
data_fig = mutate(
  data_fig,
  plots = map2(
    plots, name,
    function(p, name) {
      p = p + labs(
        x = name
      )
    }
  )
)

# summarise as patchwork
data_fig = group_by(
  data_fig,
  scientific_name
) |> 
  summarise(
    plots = list(
      wrap_plots(
        plots,
        ncol = 5
      )
    )
  )

# add title as sp
data_fig = mutate(
  data_fig,
  plots = map2(
    plots, scientific_name,
    function(p, name) {
      p = p & plot_annotation(
        title = name
      )
    }
  )
)
```

```{r}
# save images
cairo_pdf(
  filename = "figs/fig_occupancy_predictors.pdf",
  onefile = TRUE, width = 10, height = 2
)
data_fig$plots
dev.off()
```

## Mapping species occupancy

```{r}

```

```{r}

```

